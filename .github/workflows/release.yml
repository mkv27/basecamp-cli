name: release-binaries

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

env:
  BIN_NAME: basecamp-cli

jobs:
  verify-tag:
    runs-on: ubuntu-latest
    steps:
      - name: Validate strict SemVer tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must match vX.Y.Z. Received: ${TAG}"
            exit 1
          fi

  build:
    name: build-${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    needs: verify-tag
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            archive_ext: tar.gz
          - os: macos-15-intel
            target: x86_64-apple-darwin
            archive_ext: tar.gz
          - os: macos-14
            target: aarch64-apple-darwin
            archive_ext: tar.gz
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            archive_ext: zip

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Rust toolchain (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          rustup toolchain install 1.93.1 --profile minimal
          rustup default 1.93.1
          rustup target add ${{ matrix.target }} --toolchain 1.93.1
          rustc --version
          cargo --version

      - name: Install Rust toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          rustup toolchain install 1.93.1 --profile minimal
          rustup default 1.93.1
          rustup target add ${{ matrix.target }} --toolchain 1.93.1
          rustc --version
          cargo --version

      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }}

      - name: Package (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          STAGE="${BIN_NAME}-${{ matrix.target }}"
          mkdir -p "${STAGE}"
          cp "target/${{ matrix.target }}/release/${BIN_NAME}" "${STAGE}/"
          tar -czf "${STAGE}.tar.gz" "${STAGE}"

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $Stage = "${env:BIN_NAME}-${{ matrix.target }}"
          New-Item -Path $Stage -ItemType Directory -Force | Out-Null
          Copy-Item "target/${{ matrix.target }}/release/${env:BIN_NAME}.exe" "$Stage/${env:BIN_NAME}.exe"
          Compress-Archive -Path $Stage -DestinationPath "$Stage.zip" -Force

      - name: Upload packaged artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ env.BIN_NAME }}-${{ matrix.target }}
          path: ${{ env.BIN_NAME }}-${{ matrix.target }}.${{ matrix.archive_ext }}

  release:
    name: publish-release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: dist

      - name: Prepare release files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release
          find dist -maxdepth 3 -type f -exec cp {} release/ \;
          cd release
          found=0
          : > SHA256SUMS
          for file in ${BIN_NAME}-*; do
            if [ -f "${file}" ]; then
              sha256sum "${file}" >> SHA256SUMS
              found=1
            fi
          done
          if [ "${found}" -ne 1 ]; then
            echo "No packaged release assets were found."
            exit 1
          fi
          sort -o SHA256SUMS SHA256SUMS

      - name: Create GitHub release and upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          if gh release view "${TAG}" --repo "${GITHUB_REPOSITORY}" >/dev/null 2>&1; then
            gh release upload "${TAG}" release/* --repo "${GITHUB_REPOSITORY}" --clobber
          else
            gh release create "${TAG}" release/* --repo "${GITHUB_REPOSITORY}" --verify-tag --generate-notes
          fi

      - name: Verify uploaded asset digests
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          cd release

          verified_any=0
          for file in ${BIN_NAME}-*; do
            if [ ! -f "${file}" ]; then
              continue
            fi

            verified_any=1
            LOCAL_SHA256="$(sha256sum "${file}" | awk '{print $1}')"
            REMOTE_DIGEST="$(gh api \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}" \
              --jq ".assets[] | select(.name == \"${file}\") | .digest" | head -n1 || true)"

            if [ -z "${REMOTE_DIGEST}" ]; then
              echo "Missing digest for uploaded asset: ${file}"
              exit 1
            fi

            REMOTE_SHA256="${REMOTE_DIGEST#sha256:}"
            if [ "${REMOTE_SHA256}" = "${REMOTE_DIGEST}" ]; then
              echo "Unexpected digest format for ${file}: ${REMOTE_DIGEST}"
              exit 1
            fi

            if [ "${LOCAL_SHA256}" != "${REMOTE_SHA256}" ]; then
              echo "Digest mismatch for ${file}"
              echo "Local:  ${LOCAL_SHA256}"
              echo "Remote: ${REMOTE_SHA256}"
              exit 1
            fi
          done

          if [ "${verified_any}" -ne 1 ]; then
            echo "No packaged release assets were verified."
            exit 1
          fi

          echo "GitHub release asset digests match local SHA-256 values."
